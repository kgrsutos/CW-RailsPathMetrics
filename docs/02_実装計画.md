# 02_実装計画

## 技術スタック

### 言語とバージョン
- Go 1.24.5 (mise.tomlで指定)

### 主要ライブラリ
- **CLIフレームワーク**: [Cobra](https://github.com/spf13/cobra) v1.8.1
  - GitHub Stars: 37k+
  - Go言語のCLIフレームワークのデファクトスタンダード
  - kubectl, dockerなどの主要CLIツールで採用実績あり

- **AWS SDK**: aws-sdk-go-v2
  - AWS公式のGo SDK v2を使用
  - CloudWatch Logsクライアントを使用

- **ロガー**: slog (Go標準ライブラリ)
  - Go 1.21から標準ライブラリに追加された構造化ログライブラリ

- **Linter**: golangci-lint v1.61.0
  - GitHub Stars: 15k+
  - 複数のlinterを統合したツール
  - Go言語のlinterのデファクトスタンダード

- **テストライブラリ**
  - testing (Go標準ライブラリ)
  - testify v1.9.0 (アサーションライブラリ)
  - gomock v1.6.0 (モックライブラリ)

## プロジェクト構成

```
CW-RailsPathMetrics/
├── cmd/
│   └── cwrstats/
│       └── main.go              # エントリーポイント
├── internal/
│   ├── cli/
│   │   ├── root.go             # ルートコマンド
│   │   └── analyze.go          # analyzeサブコマンド
│   ├── cloudwatch/
│   │   ├── client.go           # CloudWatchクライアント
│   │   └── client_test.go
│   ├── analyzer/
│   │   ├── analyzer.go         # ログ解析メインロジック
│   │   ├── parser.go           # ログパーサー
│   │   ├── aggregator.go       # 集計処理
│   │   └── *_test.go
│   └── models/
│       └── types.go            # データ型定義
├── pkg/
│   └── timeutil/               # 時刻処理ユーティリティ
├── scripts/
│   └── setup.sh                # 開発環境セットアップ
├── docker/
│   ├── Dockerfile
│   └── docker-compose.yml
├── .golangci.yml               # Linter設定
├── go.mod
├── go.sum
├── Makefile                    # ビルド・テストタスク
└── README.md

```

## 実装フェーズ

### Phase 1: プロジェクト基盤構築 (1日目)
1. **プロジェクト初期化**
   - go.modの作成
   - 基本的なディレクトリ構造の作成
   - Makefile作成

2. **CLIフレームワーク実装**
   - Cobraを使用したコマンド構造の実装
   - rootコマンドとanalyzeサブコマンドの骨組み作成
   - コマンドラインオプションの定義

3. **開発環境整備**
   - golangci-lint設定
   - Docker環境構築
   - 基本的なMakefileタスク定義

### Phase 2: AWS連携機能実装 (2日目)
1. **CloudWatchクライアント実装**
   - AWS SDKの初期化
   - 認証処理（Profile対応）
   - CloudWatch Logs APIラッパー作成

2. **ログ取得機能**
   - FilterLogEventsの実装
   - ページネーション対応
   - エラーハンドリング

### Phase 3: ログ解析機能実装 (3日目)
1. **ログパーサー実装**
   - Railsログフォーマットの解析
   - Started/Completedログの識別
   - セッションIDとパスの抽出

2. **パスパラメータ正規化**
   - 数値IDパラメータの検出
   - パスの正規化処理
   - テストケース作成

### Phase 4: 集計処理実装 (4日目)
1. **集計ロジック実装**
   - StartedとCompletedログの紐付け
   - 処理時間の計算
   - パス毎の統計計算

2. **JSON出力機能**
   - 出力フォーマットの定義
   - JSONエンコーディング
   - 標準出力への書き込み

### Phase 5: テストとドキュメント (5日目)
1. **単体テスト実装**
   - 各モジュールのテスト作成
   - エッジケース・コーナーケースのテスト
   - モックを使用した統合テスト

2. **ドキュメント整備**
   - READMEの更新
   - 使用方法ドキュメント
   - 開発者向けドキュメント

## テスト計画

### 単体テストカバレッジ目標
- 全体: 80%以上
- コアロジック（analyzer, parser）: 90%以上

### テストケース
1. **パーサーテスト**
   - 正常なRailsログのパース
   - 不正なフォーマットのハンドリング
   - セッションIDの抽出
   - パスの抽出

2. **正規化テスト**
   - `/users/123` → `/users/:id`
   - `/posts/456/comments/789` → `/posts/:id/comments/:id`
   - 非数値パラメータの保持

3. **集計テスト**
   - 正常な処理時間計算
   - Completedログが欠落している場合
   - 重複ログの処理
   - 大量データでのパフォーマンス

4. **CloudWatchクライアントテスト**
   - APIレスポンスのモック
   - ページネーション
   - エラーハンドリング
   - リトライ処理

## リスクと対策

### 技術的リスク
1. **大量ログの処理**
   - 対策: ストリーミング処理の実装、メモリ効率的なデータ構造

2. **CloudWatch API制限**
   - 対策: 適切なリトライロジック、レート制限の実装

3. **ログフォーマットの多様性**
   - 対策: 柔軟なパーサー実装、設定可能なフォーマット対応

### スケジュールリスク
1. **AWS SDKの学習コスト**
   - 対策: 早期にプロトタイプ作成、ドキュメント確認

2. **テスト作成の工数**
   - 対策: テスト駆動開発の採用、早期からのテスト実装

## 成果物

1. **実行可能バイナリ**: `cwrstats`
2. **Dockerイメージ**: ローカル実行用
3. **ドキュメント**: README.md、使用方法ガイド
4. **テストスイート**: 単体テスト、統合テスト

## 実装優先順位

1. **必須機能**
   - CloudWatchログ取得
   - Started/Completedログの解析
   - パス毎の集計
   - JSON出力

2. **品質保証**
   - 単体テスト（80%カバレッジ）
   - Lintチェック
   - エラーハンドリング

3. **運用性**
   - Docker環境
   - ログ出力（slog）
   - ドキュメント